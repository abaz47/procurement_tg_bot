# Бот для отправки заявок на закупку через Telegram

## Возможности

- Создание заявок на закупку с выбором отдела
- Указание товара и количества
- Выбор приоритета заявки
- Автоматическая отправка заявок администраторам
- Контроль доступа пользователей
- Логирование

## Развертывание

### Предварительные требования

- Docker и Docker Compose
- Токен Telegram бота (получить у @BotFather)

### Быстрый старт

1. **Клонируйте репозиторий:**
   ```bash
   git clone git@github.com:abaz47/procurement_tg_bot.git
   cd NM-procurement_tg_bot
   ```

2. **Создайте файл `.env`:**
   ```bash
   echo "TELEGRAM_BOT_TOKEN=your_bot_token_here" > .env
   ```

3. **Настройте пользователей в `users.cfg`:**
   ```ini
   [ADMINS]
   123456789  # ID администратора
   987654321  # ID другого администратора

   [USERS]
   111111111  # ID пользователя
   222222222  # ID другого пользователя
   ```

4. **Запустите развертывание:**
   ```bash
   ./deploy.sh
   ```

### Управление ботом

- **Просмотр логов:** `docker-compose logs -f`
- **Остановка:** `docker-compose down`
- **Перезапуск:** `docker-compose restart`
- **Обновление:** `./deploy.sh`

## Управление пользователями

### Расположение файла конфигурации

Файл `users.cfg` находится **на хостовой системе** (вне контейнера) и монтируется в контейнер. Это означает:

-  Файл сохраняется при пересоздании контейнера
-  Можно редактировать прямо на сервере
-  Изменения сразу видны в контейнере

### Способы управления пользователями

#### 1. Скрипт управления (рекомендуется)

```bash
# Показать всех пользователей
./manage_users.sh list

# Добавить администратора
./manage_users.sh add-admin 123456789 "Иван Иванов"

# Добавить пользователя
./manage_users.sh add-user 987654321 "Петр Петров"

# Удалить пользователя
./manage_users.sh remove 123456789

# Редактировать файл в текстовом редакторе
./manage_users.sh edit

# Создать резервную копию
./manage_users.sh backup
```

#### 2. Прямое редактирование

```bash
# Редактирование файла
nano users.cfg
# или
vim users.cfg

# После изменений - перезагрузка конфигурации
# Отправить /reload_users администратором в Telegram
# или
docker-compose restart
```

#### 3. Через Telegram

Администраторы могут использовать команду `/reload_users` для перезагрузки конфигурации после изменения файла на сервере.

## Конфигурация

### Файл `users.cfg`

```ini
[ADMINS]
# ID администраторов (получают заявки)
123456789  # Иван Иванов
987654321  # Петр Петров

[USERS]
# ID пользователей (могут создавать заявки)
111111111  # Сотрудник 1
222222222  # Сотрудник 2
```

### Получение ID пользователя

1. Напишите боту @userinfobot
2. Перешлите ему сообщение от нужного пользователя
3. Скопируйте ID из ответа

## Команды бота

- `/start` - Начать работу с ботом
- `/help` - Показать справку
- `/order` - Создать заявку на закупку
- `/cancel` - Отменить создание заявки
- `/reload_users` - Перезагрузить список пользователей (только для админов)

## Мониторинг

### Просмотр логов

```bash
# Все логи
docker-compose logs

# Последние логи с отслеживанием
docker-compose logs -f --tail=100

# Логи за определенный период
docker-compose logs --since="2024-01-01T00:00:00"
```

### Проверка статуса

```bash
# Статус контейнера
docker-compose ps

# Использование ресурсов
docker stats procurement-tg-bot
```

## Обновление

1. **Остановите бота:**
   ```bash
   docker-compose down
   ```

2. **Обновите код:**
   ```bash
   git pull
   ```

3. **Запустите развертывание:**
   ```bash
   ./deploy.sh
   ```

## Резервное копирование

Важно регулярно создавать резервные копии:

- `users.cfg` - конфигурация пользователей
- `.env` - переменные окружения
- `logs/` - логи (опционально)

```bash
# Создание резервной копии конфигурации
./manage_users.sh backup

# Архивация всего проекта
tar -czf bot-backup-$(date +%Y%m%d).tar.gz users.cfg .env logs/
```

## Устранение неполадок

### Бот не отвечает

1. **Проверьте логи:**
   ```bash
   docker-compose logs -f
   ```

2. **Убедитесь, что токен корректный:**
   ```bash
   cat .env
   ```

3. **Проверьте статус контейнера:**
   ```bash
   docker-compose ps
   ```

### Ошибки доступа

1. **Проверьте конфигурацию пользователей:**
   ```bash
   ./manage_users.sh list
   ```

2. **Перезагрузите конфигурацию:**
   ```bash
   # Через Telegram: отправить /reload_users
   # или
   docker-compose restart
   ```

### Проблемы с Docker

1. **Проверьте, что Docker запущен:**
   ```bash
   docker --version
   docker-compose --version
   ```

2. **Пересоберите образ:**
   ```bash
   docker-compose build --no-cache
   docker-compose up -d
   ```

3. **Очистите систему (если нужно место):**
   ```bash
   docker system prune -f
   ```

## Поддержка

При возникновении проблем:

1. Проверьте логи: `docker-compose logs -f`
2. Убедитесь в корректности конфигурации
3. Обратитесь к администратору системы

## Файлы проекта

```
NM-procurement_tg_bot/
├── bot.py              # Основной код бота
├── messages.py         # Текстовые сообщения
├── requirements.txt    # Python зависимости
├── Dockerfile          # Docker образ
├── docker-compose.yml  # Docker Compose конфигурация
├── deploy.sh           # Скрипт развертывания
├── manage_users.sh     # Управление пользователями
├── .env               # Переменные окружения (создается)
├── users.cfg          # Конфигурация пользователей (создается)
└── logs/              # Директория логов (создается)
```
